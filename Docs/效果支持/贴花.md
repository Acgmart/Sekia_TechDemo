# 贴花
贴花(Decal)效果在游戏中应用的很广泛 可以模拟表面附着物  
比如子弹击中墙壁后的弹痕、墙壁上挂着的海报/收款码  
如果不使用贴花而是将贴花直接画到墙壁的贴图上则灵活性大降  
附着物的法线/粗糙度/金属度与墙壁会存在较大差异 不方便用同一个shader  
如果附着物的数量极为庞大 比如喷射类型的游戏可以喷涂整个场景 不适用贴花  
比如墙上的海报非常古旧 有一角已经翻卷了 对法线和阴影细节要求高 也不适用  
![](../Assets/资源库/贴花/在墙壁上附着二维码.png)

# 贴花的实现
贴花并没有确切的形状 这里我们用一个Cube来为贴花提供光栅化必要的模型  
将Cube的一部分埋入地下 地面与Cube就有了一个相交的区域 这个区域用来着色  
需要计算出一套UV用来采样贴图 UV的位置必须是固定的 不会随着观察角度变化  
这里我们用模型空间的XZ轴来表达UV 相当于将图片贴在Cube朝上的那一面  

## 片元shader中基于深度值还原Cube模型空间的世界坐标
方法一：根据深度值重构NDC坐标 再利用逆VP矩阵和逆M矩阵得到模型空间的世界坐标  
方法二：沿着观察方向前进并与场景发生碰撞 基于向量比例关系求碰撞点  
在Assets/资源库/贴花/Decal_Unlit.shader使用的是基于方法二的实现  

## 使用ddx/ddy计算碰撞点的世界空间法线
如果没有屏幕空间的法线贴图可供采样 那么只能算出来碰撞点的法线  
float3 normalWS = normalize(cross(ddy(positionWS), ddx(positionWS)));  
ddx和ddy方法用于获取相邻像素之间的输入值的差值向量 并与法线构成垂直关系  

## 世界空间的多层法线混合问题
如果贴花用来模拟弹痕/血液 贴花得自带法线效果 而且还能随着时间淡化消失  
墙壁的法线和贴花的法线需要在世界空间混合 或者在切线空间混合  
参考：com.unity.render-pipelines.core/ShaderLibrary/CommonMaterial.hlsl  
BlendNormalWorldspaceRNM 和 BlendNormalRNM  

# 使用过程中的其他问题
贴花RenderQueue应根据附着关系要调整 Box范围内避免进入其他物体  
贴花的Box可以旋转来调整朝向 但是不太方便附着在墙角或者很薄的墙壁  
附着在墙角时UV会被拉伸使图片走样 很薄的墙壁很容易就被Box穿透  
这些都是使用问题 我们当然可以控制贴花只在合适的地方显示  
![](../Assets/资源库/贴花/贴花穿模问题1.png)
![](../Assets/资源库/贴花/贴花穿模问题2.png)