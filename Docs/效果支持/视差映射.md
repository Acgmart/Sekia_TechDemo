# 视差映射
视差映射通常用于在平滑表面添加高度细节 类似于法线贴图  
比如鹅卵石路、青苔、墙砖、流动的云海、岩体等  
凹处的光照会比平滑处暗 有额外的AO、阴影遮挡等细节 使人眼感觉到高度差  
参考文章：[Unity Shader基于视差映射的云海效果](https://zhuanlan.zhihu.com/p/83355147)

# 视差映射的实现
视差映射使用的模型面数会非常低 不依赖于顶点数量而是靠片元shader制造3D细节假象  
输入：高度贴图 单通道浮点数 0表示与表面齐平 1表示最深的凹陷值  
高度贴图提供了一个简易的空间概念 只能向下凹、用最大深度值的百分比表示深度  
视差：当观察方向与表面接触时 因为表面的下面有凹痕 观察方向会继续前进造成落点偏移  
确定落点位置的方式多种多样 有的从性能考虑得到可接受的效果 有的则考虑提高精确度  

## 切线空间内造成纹理偏移
切线空间内X轴为tangent Y轴为bitangent Z轴为normal  
切线空间的XY平面上的偏移可以作为UV偏移  
将观察方向V转换到切线空间后 就可以沿着观察方向偏移UV  
要想UV有合理的偏移需要保证UV的连续以及偏移距离不能太大  
为了减小误差 每次前进一小步进行深度检测判断可能的落点  
每前进一小步时 观察落点下降 观察落点采样高度图得到的深度值在变化  
不同算法的差异体现在估算最终落点位置

## Steep Parallax Mapping 陡峭视差映射
检测到落点低于深度时 使用上一个落点

## Relief Parallax Mapping 浮雕视差映射
检测到落点低于深度时 取落点与上一个落点的终点继续检测提高精度

## Parallax Occlusion Mapping 视差遮蔽映射
检测到落点低于深度时 取落点与上一个落点的差值  
效果案例：Assets/资源库/视差云  
![](../Assets/资源库/视差云/云雾缭绕的山峰.gif)

# 视差映射的后续着色
参考文章：https://segmentfault.com/a/1190000003920502
使用高度图生成法线贴图 => 把高度图存在法线贴图里
视差映射求阴影强度的方式和求落点的方式类似
从落点开始沿着切线空间的光源方向进步 如果落点低于深度则被遮挡
硬阴影：没有找到任何落点低于深度 阴影系数为1 否则为0
软阴影：最后一个低于深度的落点的步数为index
　　阴影系数 = (落点深度-高度图采样深度)*(1-index/_StepCount)